<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PumAI </title>
<link rel="icon" type="image/png" href="img/chatbot2.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* Reset b√°sico */
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}

body {
  height: 100vh;                                    /* Establece la altura al 100% de la ventana visible (viewport) */
  background-image: url('img/captura.png');         /* Define la imagen de fondo. ¬°Cambia la ruta! */
  background-size: cover;                           /* Asegura que la imagen cubra todo el body sin dejar espacios */
  background-position: center;                      /* Centra la imagen de fondo */
  background-repeat: no-repeat;                     /* Evita que la imagen de fondo se repita (en mosaico) */
  background-attachment: fixed;                     /* Mantiene la imagen de fondo fija al hacer scroll */
  display: flex;                                    /* Convierte el body en un contenedor flexible (Flexbox) */
  justify-content: center;                          /* Centra el contenido secundario horizontalmente */
  align-items: center;                              /* Centra el contenido secundario verticalmente */
  filter: brightness(1.08) contrast(1.1);           /* Aplica filtros visuales: m√°s brillo (1.08) y contraste (1.1) */
  }

/* Bot√≥n flotante */
#assistant-icon {
  position: fixed;                 /* Mantiene el elemento en una posici√≥n fija en la ventana, sin moverse al hacer scroll */
  bottom: 20px;                    /* Fija la posici√≥n a 20 p√≠xeles del borde inferior de la ventana */
  right: 20px;                     /* Fija la posici√≥n a 20 p√≠xeles del borde derecho de la ventana */
  width: 70px;                     /* Establece el ancho del elemento a 70 p√≠xeles */
  height: 70px;                    /* Establece la altura del elemento a 70 p√≠xeles */
  border-radius: 50%;              /* Le da un radio de borde del 50%, haciendo que el elemento sea un c√≠rculo perfecto */
  background: #ffffff;           /* Establece el color de fondo del c√≠rculo a blanco */
  display: flex;                   /* Convierte el elemento en un contenedor flexible (Flexbox) */
  justify-content: center;         /* Centra horizontalmente el contenido interno (el icono o texto) */
  align-items: center;             /* Centra verticalmente el contenido interno (el icono o texto) */
  cursor: pointer;                 /* Cambia el cursor a una mano/puntero para indicar que es un elemento clickable */
  box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* Agrega una sombra al elemento para que sobresalga de la p√°gina */
  transition: transform 0.2s;      /* Suaviza la transici√≥n de la propiedad 'transform' durante 0.2 segundos (para efectos al pasar el rat√≥n) */
  }

#assistant-icon:hover {
  transform: scale(1.1);           /* Aumenta el tama√±o del icono en un 10% (1.1 veces) al pasar el rat√≥n, creando un efecto de zoom */
}

#assistant-icon img {
  width: 52px;                 /* Fija el ancho de la imagen interna a 52 p√≠xeles */
  height: 52px;                /* Fija la altura de la imagen interna a 52 p√≠xeles */
}

/* Contenedor del chat */
#chat-box-container {
  position: fixed;                 /* Mantiene la caja de chat en una posici√≥n fija en la ventana (no se mueve al hacer scroll) */
  bottom: 100px;                   /* Fija la posici√≥n a 100 p√≠xeles del borde inferior de la ventana */
  right: 20px;                     /* Fija la posici√≥n a 20 p√≠xeles del borde derecho de la ventana */
  width: 380px;                    /* Establece el ancho fijo de la caja de chat a 380 p√≠xeles */
  max-height: 520px;               /* Limita la altura m√°xima de la caja a 520 p√≠xeles */
  background: rgba(255,255,255,0.97); /* Establece un fondo blanco con una ligera transparencia (97% de opacidad) */
  border-radius: 15px;             /* Redondea las esquinas de la caja de chat con un radio de 15 p√≠xeles */
  display: none;                   /* Inicialmente oculta la caja de chat, que ser√° mostrada con JavaScript */
  flex-direction: column;          /* Organiza los elementos internos (Flexbox) en una columna vertical */
  box-shadow: 0 5px 20px rgba(0,0,0,0.3); /* Agrega una sombra al contenedor para darle profundidad */
  overflow: hidden;                /* Recorta cualquier contenido que se desborde fuera de los l√≠mites de la caja */
  z-index: 999;                    /* Asegura que la caja de chat aparezca por encima de casi todos los dem√°s elementos de la p√°gina */
}

/* Header */
.chat-header {
  background: #012169;           /* Establece el color de fondo del encabezado (un azul oscuro) */
  color: white;                  /* Establece el color del texto dentro del encabezado a blanco */
  font-weight: bold;             /* Hace que la fuente del texto sea negrita (bold) */
  padding: 10px;                 /* Agrega un relleno (espacio interno) de 10 p√≠xeles alrededor del contenido */
  display: flex;                 /* Convierte el encabezado en un contenedor flexible (Flexbox) */
  align-items: center;           /* Centra los elementos internos verticalmente */
  justify-content: center;       /* Centra los elementos internos horizontalmente */
  gap: 8px;                      /* Agrega un espacio de 8 p√≠xeles entre los elementos internos (como el texto y la imagen) */
  border-top-left-radius: 15px;  /* Redondea la esquina superior izquierda con un radio de 15 p√≠xeles */
  border-top-right-radius: 15px; /* Redondea la esquina superior derecha con un radio de 15 p√≠xeles */
}

.chat-header img {
  width: 25px;                   /* Fija el ancho de cualquier imagen dentro del encabezado a 25 p√≠xeles */
  height: 25px;                  /* Fija la altura de cualquier imagen dentro del encabezado a 25 p√≠xeles */
}
/* Contenido */
.chat-content {
  flex-grow: 1;                  /* Permite que este elemento crezca y ocupe todo el espacio vertical disponible en el contenedor padre (chat-box-container) */
  padding: 10px;                 /* Agrega un relleno (espacio interno) de 10 p√≠xeles alrededor de todo el contenido */
  overflow-y: auto;              /* Agrega una barra de desplazamiento vertical autom√°tica si el contenido excede la altura m√°xima */
  display: flex;                 /* Convierte el contenido en un contenedor flexible (Flexbox) */
  flex-direction: column;        /* Apila los mensajes internos verticalmente, de arriba abajo */
  gap: 8px;                      /* Agrega un espacio vertical de 8 p√≠xeles entre los mensajes */
}

/* Mensajes */
.message {
  padding: 8px 12px;             /* Agrega relleno: 8px arriba/abajo y 12px izquierda/derecha */
  border-radius: 10px;           /* Redondea las esquinas de cada burbuja de mensaje */
  max-width: 85%;                /* Limita el ancho m√°ximo de cada mensaje al 85% del contenedor padre */
  word-wrap: break-word;         /* Asegura que las palabras muy largas se rompan y pasen a la siguiente l√≠nea, evitando desbordamientos horizontales */
}

.user {
  background: rgba(1,33,105,0.8); /* Establece un fondo azul oscuro semi-transparente (80% de opacidad) para los mensajes del usuario */
  color: white;                  /* Establece el color del texto a blanco para contrastar con el fondo oscuro */
  align-self: flex-end;          /* Alinea la burbuja de mensaje a la DERECHA del contenedor (Flexbox) */
}

.bot {
  background: rgba(224,224,224,0.9); /* Establece un fondo gris claro semi-transparente (90% de opacidad) para los mensajes del bot */
  align-self: flex-start;        /* Alinea la burbuja de mensaje a la IZQUIERDA del contenedor (Flexbox) */
}

/* Input */
.input-area {
  display: flex;                 /* Convierte el √°rea de entrada en un contenedor flexible (Flexbox) para alinear el campo de texto y el bot√≥n */
  border-top: 1px solid #ddd;    /* Agrega una l√≠nea gris claro (borde superior) para separar el √°rea de entrada del historial de chat */
}

.input-area input {
  flex-grow: 1;                 /* Permite que el campo de entrada ocupe todo el espacio horizontal restante en el contenedor Flexbox (`.input-area`) */
  border: none;                   /* Elimina cualquier borde predeterminado del campo de entrada */
  padding: 10px;                  /* Agrega un relleno (espacio interno) de 10 p√≠xeles alrededor del texto dentro del campo */
  font-size: 14px;                /* Establece el tama√±o de la fuente del texto a 14 p√≠xeles */
  outline: none;                  /* Elimina el contorno (generalmente azul o negro) que aparece cuando el campo est√° enfocado (haciendo clic en √©l) */
}

.input-area button {
  background: #FFD700;           /* Establece el color de fondo del bot√≥n a dorado (Gold) */
  border: none;                   /* Elimina cualquier borde predeterminado del bot√≥n */
  padding: 10px 15px;             /* Agrega relleno: 10px arriba/abajo y 15px izquierda/derecha */
  cursor: pointer;                /* Cambia el cursor a una mano/puntero, indicando que es un elemento clickable */
  font-weight: bold;              /* Hace que el texto del bot√≥n sea negrita (bold) */
  transition: 0.2s;               /* Suaviza cualquier cambio de estilo (como el color de fondo en hover) durante 0.2 segundos */
}

.input-area button:hover {
  background: #e6c200;           /* Cambia el color de fondo del bot√≥n a un dorado ligeramente m√°s oscuro cuando el rat√≥n pasa por encima */
}

/* Botones FAQ y Feedback */
details {
  background-color: #91b5eb;       /* Establece el color de fondo del contenedor (un azul claro) */
  color: white;                    /* Establece el color del texto dentro del contenedor a blanco */
  margin: 2px 0;                   /* Agrega un margen de 2 p√≠xeles arriba y abajo, y 0 a los lados, para separarlo de otros elementos */
  border-radius: 8px;              /* Redondea las esquinas del contenedor con un radio de 8 p√≠xeles */
  padding: 3px 4px;                /* Agrega un relleno (espacio interno) de 3 p√≠xeles arriba/abajo y 4 p√≠xeles izquierda/derecha */
}

details summary {
  cursor: pointer;                 /* Cambia el cursor a una mano/puntero, indicando que este elemento es interactivo y clickable */
  font-weight: bold;               /* Hace que el texto del sumario (el t√≠tulo visible) sea negrita */
  padding: 5px;                    /* Agrega un relleno (espacio interno) de 5 p√≠xeles alrededor del texto del sumario */
  font-size: 16px;                 /* Establece el tama√±o de la fuente a 16 p√≠xeles */
  font-family: 'verdana';          /* Establece la fuente del texto a 'Verdana' (si est√° disponible) */
  color: black;                    /* Establece el color del texto del sumario a negro */
}

details[open] summary {
  color: black;                    /* Mantiene el color del texto del sumario en negro cuando el contenido est√° desplegado (abierto) */
}

.faq-btn {
  background-color: #f9f9f9;       /* Establece un color de fondo gris muy claro para el bot√≥n */
  color: #012169;                  /* Establece el color del texto del bot√≥n a azul oscuro */
  border: 1px solid #ccc;          /* Agrega un borde delgado (1px) de color gris claro alrededor del bot√≥n */
  border-radius: 5px;              /* Redondea ligeramente las esquinas del bot√≥n con un radio de 5 p√≠xeles */
  padding: 6px;                    /* Agrega un relleno (espacio interno) de 6 p√≠xeles alrededor del texto */
  margin: 3px 0;                   /* Agrega un margen de 3 p√≠xeles arriba y abajo, y 0 a los lados, para separarlo de otros botones */
  text-align: left;                /* Alinea el texto del bot√≥n a la izquierda */
  cursor: pointer;                 /* Cambia el cursor a una mano/puntero, indicando que el bot√≥n es clickable */
  width: 100%;                     /* Hace que el bot√≥n ocupe el 100% del ancho de su contenedor padre */
  font-size: 14px;                 /* Establece el tama√±o de la fuente a 14 p√≠xeles */
  font-family: 'Verdana', sans-serif; /* Establece la fuente del texto a Verdana (o una fuente sans-serif si no est√° disponible) */
  line-height: 1.4;                /* Establece el espaciado entre l√≠neas a 1.4 veces el tama√±o de la fuente para mejor legibilidad */
}

.faq-btn:hover {
  background-color: #FFD700;       /* Cambia el color de fondo a dorado cuando el rat√≥n pasa por encima (efecto hover) */
  color: #012169;                  /* Mantiene el color del texto en azul oscuro para el contraste */
}

.back-btn {
  background-color: #012169;       /* Establece el color de fondo del bot√≥n a azul oscuro */
  color: #FFD700;                  /* Establece el color del texto del bot√≥n a dorado (para alto contraste) */
  width: 100%;                     /* Hace que el bot√≥n ocupe el 100% del ancho de su contenedor padre */
  padding: 6px;                    /* Agrega un relleno (espacio interno) de 6 p√≠xeles alrededor del texto */
  margin: 5px 0;                   /* Agrega un margen de 5 p√≠xeles arriba y abajo, y 0 a los lados, para separarlo */
  border-radius: 5px;              /* Redondea ligeramente las esquinas del bot√≥n con un radio de 5 p√≠xeles */
  cursor: pointer;                 /* Cambia el cursor a una mano/puntero, indicando que el bot√≥n es clickable */
}

.back-btn:hover {
  background-color: #FFD700;       /* Invierte el color de fondo a dorado cuando el rat√≥n pasa por encima */
  color: #012169;                  /* Invierte el color del texto a azul oscuro cuando el rat√≥n pasa por encima */
}

.feedback-btn {
  background-color: #FFD700;       /* Establece el color de fondo del bot√≥n a dorado */
  color: #012169;                  /* Establece el color del texto del bot√≥n a azul oscuro */
  margin: 5px 3px;                 /* Agrega un margen de 5 p√≠xeles arriba/abajo y 3 p√≠xeles izquierda/derecha para espaciarlo de otros elementos */
  padding: 5px 10px;               /* Agrega un relleno (espacio interno) de 5 p√≠xeles arriba/abajo y 10 p√≠xeles izquierda/derecha */
  border-radius: 5px;              /* Redondea las esquinas del bot√≥n con un radio de 5 p√≠xeles */
  border: none;                    /* Elimina cualquier borde predeterminado del bot√≥n */
  cursor: pointer;                 /* Cambia el cursor a una mano/puntero, indicando que el bot√≥n es clickable */
}

.feedback-btn:hover {
  background-color: #012169;       /* Invierte el color de fondo a azul oscuro cuando el rat√≥n pasa por encima */
  color: #FFD700;                  /* Invierte el color del texto a dorado cuando el rat√≥n pasa por encima */
}

@media screen and (max-width: 600px) {
  #chat-box-container {
    width: 90%;
    right: 5%;
    bottom: 90px;
    max-height: 75vh;
  }
  #assistant-icon {
    width: 60px;
    height: 60px;
    bottom: 15px;
    right: 15px;
  }
  #assistant-icon img { width: 45px; height: 45px; }
  .chat-header { font-size: 14px; }
  .input-area input { font-size: 13px; }
  .faq-btn { font-size: 13px; }
}

html, body {
  height: 100%;
  overflow: hidden;
}
.chat-content {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}


</style>
</head>
<body>

<!-- Bot√≥n flotante -->
<div id="assistant-icon"><img src="img/asistencia.gif" alt="Chatbot"></div> 

<!-- Chat -->
<div id="chat-box-container">
  <div class="chat-header">
    <img src="img/pumas.gif" alt="Logo UNAM"> PumAI üêæ
  </div>
  <div id="chat-content" class="chat-content"></div>
  <div class="input-area">
    <input type="text" id="user-input" placeholder="Escribe tu mensaje..." />
    <button id="send-btn">Enviar</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
// üîπ Configuraci√≥n Firebase
// ‚úÖ Configuraci√≥n y modo sin conexi√≥n
let offlineMode = !navigator.onLine;

// Solo inicializa Firebase si hay internet
if (!offlineMode) {
  const firebaseConfig = {
    apiKey: "AIzaSyAhvjxgrTdlk95zZIZEyuVkUQqFLwy7f34",
    authDomain: "aura-8e04e.firebaseapp.com",
    databaseURL: "https://aura-8e04e-default-rtdb.firebaseio.com",
    projectId: "aura-8e04e",
    storageBucket: "aura-8e04e.firebasestorage.app",
    messagingSenderId: "112158125985",
    appId: "1:112158125985:web:27d0af1519c040677d65e0",
    measurementId: "G-H17VPQCS6F"
  };

  firebase.initializeApp(firebaseConfig);
  var database = firebase.database();
  console.log("‚úÖ Firebase inicializado correctamente");
} else {
  console.warn("‚ö†Ô∏è Modo sin conexi√≥n activado: Firebase deshabilitado.");

}


// Variables
const assistantIcon = document.getElementById('assistant-icon'); // Selecciona el bot√≥n flotante del asistente.
const chatBoxContainer = document.getElementById('chat-box-container'); // Selecciona el contenedor de la ventana de chat.
const chatContent = document.getElementById('chat-content'); // Selecciona el √°rea de visualizaci√≥n de mensajes (historial).
const userInput = document.getElementById('user-input'); // Selecciona el campo de texto donde el usuario escribe.
const sendBtn = document.getElementById('send-btn'); // Selecciona el bot√≥n de enviar mensaje.

let firstHello = false; // Bandera: Indica si el saludo inicial del bot ya ha sido enviado (falso por defecto).
let waitingFeedback = false; // Bandera: Indica si el sistema est√° esperando una respuesta de "s√≠/no" sobre la utilidad de la respuesta.
let waitingComment = false; // Bandera: Indica si el sistema est√° esperando un comentario de texto adicional del usuario.
let waitingMoreHelp = false; // Bandera: Indica si el sistema est√° esperando una confirmaci√≥n o nueva solicitud de ayuda.
// Variable para "¬øNecesitas algo m√°s?"

// Funci√≥n para verificar conexi√≥n a internet
function checkInternetConnection() {
  if (!navigator.onLine) {
    typeMessage("‚ö†Ô∏è ¬°Atenci√≥n! Por el momento no podemos asistirte debido a problemas de conexi√≥n a internet.");
    return false;
  }
  return true;
}

// Funci√≥n para cerrar conversaci√≥n
function closeConversation() {
  typeMessage("¬°Hasta pronto! üëã Gracias por usar PumAI.");
  setTimeout(() => {
    chatBoxContainer.style.display='none';
    chatContent.innerHTML="";
    firstHello=false;
    waitingFeedback=false;
    waitingComment=false;
    waitingMoreHelp=false;
  }, 3000); // Aumentado a 3 segundos para que se quede m√°s tiempo
}

// Mostrar/Ocultar chat
assistantIcon.onclick=()=>{
  chatBoxContainer.style.display=chatBoxContainer.style.display==='flex'?'none':'flex';
  if(!firstHello){
    chatContent.innerHTML="";
    typeMessage("üëã Bienvenido. Soy <b>PumAI</b> üêæ tu compa√±ero virtual de la UNAM. Escribe 'Hola' para comenzar.");
  }
};

// Enviar mensaje
sendBtn.addEventListener('click',sendMessage);
userInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

// Append y Type
function appendMessage(sender,text,cls){
  const m=document.createElement('div');
  m.classList.add('message',cls);
  m.innerHTML=`<strong>${sender}:</strong> ${text}`;
  chatContent.appendChild(m);
  chatContent.scrollTop=chatContent.scrollHeight;
}

function typeMessage(text,speed=25){
  let i=0;
  const message=document.createElement('div');
  message.classList.add('message','bot');
  chatContent.appendChild(message);

  function type(){
    if(i<text.length){
      message.innerHTML=`<strong>PumAI:</strong> ${text.slice(0,i+1)}`;
      i++;
      chatContent.scrollTop=chatContent.scrollHeight;
      setTimeout(type,speed);
    }
  }
  type();
}

// Enviar mensaje 
function sendMessage(){
  const text=userInput.value.trim();
  if(!text)return;

  // Verificar conexi√≥n antes de enviar
  if (!checkInternetConnection()) {
    userInput.value = text; // Mantener el mensaje para reintentar
    return;
  }

  appendMessage("T√∫",text,"user");
  userInput.value="";
  setTimeout(()=>handleBotLogic(text),300);
}

function handleBotLogic(input){
  // Verificar conexi√≥n antes de procesar
  if (!checkInternetConnection()) {
    return;
  }

  input=input.toLowerCase();

  if(!firstHello && input.includes('hola')){
    firstHello=true;
    typeMessage("¬°Hola! üíõ Soy PumAI. Puedes preguntarme cualquier duda o usar las categor√≠as.");
    setTimeout(()=>{showFAQ();},8000); 
    return;
  }
  if(!firstHello){typeMessage("Por favor, escribe ' Hola' para iniciar la conversaci√≥n. üëã");return;}

  if(waitingComment){
    waitingComment=true;
    appendMessage("T√∫",input,"user");
    typeMessage("¬°Gracias por tu comentario! La conversaci√≥n ha terminado.");
    guardarComentarioFirebase(input);
    closeConversation();
    return;
  }

  if(waitingMoreHelp){
    if(input.includes('s√≠') || input.includes('si') || input.includes('necesito') || input.includes('m√°s') || input.includes('si') || input.includes('s√≠')){
      waitingMoreHelp = false;
      typeMessage("¬°Genial! ¬øQu√© m√°s necesitas? Puedes preguntar o volver al men√∫ con 'Men√∫'.");
      return;
    } else {
      waitingMoreHelp = false;
      showFeedbackButtons();
      return;
    }
  }

  if(waitingFeedback){ return; }

  if(input.includes('gracias')){
    showFeedbackButtons();
    return;
  }

  if(input.includes('ver comentarios')){
    mostrarComentariosFirebase();
    return;
  }

  if(input.includes('adi√≥s')||input.includes('bye')){
    closeConversation();
    return;
  }

  if(input.includes('men√∫') || input.includes('menu') || input.includes('categorias')){
    showFAQ();
    return;
  }

  let botReply = generateAdvancedReply(input);
  typeMessage(botReply);
  // Despu√©s de una respuesta general, preguntar si necesitan m√°s ayuda
  setTimeout(() => {
    typeMessage("üòä ¬øNecesitas algo m√°s? Escribe 'S√≠' para volver al men√∫ principal o 'No' para finalizar.");
    waitingMoreHelp = true;
  }, 2000);
}

function generateAdvancedReply(input){
  let reply=[];
  if(/usuario|contrase√±a|login|clave/.test(input)){
    reply.push("üîê Para acceder, usa tu correo institucional y la contrase√±a de la Oficina Virtual.");
  }
  if(/curso|inscrib|matr√≠cula|registro/.test(input)){
    reply.push("üìö Para inscribirte, inicia sesi√≥n en la plataforma y busca 'Cursos disponibles'.");
  }
  if(/zoom|clase en l√≠nea|reuni√≥n/.test(input)){
    reply.push("üíª Revisa el m√≥dulo de 'Sesiones en vivo' o el correo con el link de Zoom enviado 24 horas antes.");
  }
  if(/problema|error|fallo/.test(input)){
    reply.push("‚ö†Ô∏è Si tienes problemas t√©cnicos, intenta reiniciar la sesi√≥n o contacta soporte.");
  }
  if(/cursos disponibles|lista de cursos/.test(input)){
    reply.push("üìã Aqu√≠ tienes algunos cursos populares en la plataforma UNAM: <br>1. Bienvenida a la UNAM (obligatorio para nuevos ingresos).<br>2. C√≥mputo B√°sico (gratuito, virtual).<br>3. Ingl√©s Intermedio (con evaluaci√≥n).<br>4. Redacci√≥n Administrativa.<br>Para m√°s detalles, ve a 'Cursos disponibles' en la Oficina Virtual o pregunta por uno espec√≠fico.");
  }
  if(reply.length===0){
    reply.push("ü§ñ Gracias por tu duda. Estoy procesando la informaci√≥n y te recomiendo revisar la plataforma o contactar soporte si es urgente.");
  }
  return reply.join(" ");
}
// Feedback botones
function showFeedbackButtons(){
  waitingFeedback=true;
  const container=document.createElement('div');
  container.classList.add('message','PumAI');
  const text=document.createElement('div');
  text.innerHTML="üòäüëç ¬°Me alegra haberte ayudado! <br> ¬øTe resolvi√≥ tu duda?";
  container.appendChild(text);

  const yesBtn=document.createElement('button');
  yesBtn.textContent="üëç S√≠";
  yesBtn.classList.add('feedback-btn');
  yesBtn.onclick=()=>{
    waitingFeedback=false;
    closeConversation();
  };

  const noBtn=document.createElement('button');
  noBtn.textContent="üëé No";
  noBtn.classList.add('feedback-btn');
  noBtn.onclick=()=>{
    waitingFeedback=false;
    typeMessage("Lamento no haberte ayudado üòî. Por favor, escribe un comentario sobre tu experiencia:");
    waitingComment=true;
  };

  container.appendChild(yesBtn);
  container.appendChild(noBtn);
  chatContent.appendChild(container);
  chatContent.scrollTop=chatContent.scrollHeight;
}

// Firebase comentarios
// ‚öôÔ∏è Guardar comentario (compatible offline)
function guardarComentarioFirebase(texto) {
  if (offlineMode) {
    typeMessage("üíæ Guardado localmente (sin internet). Se subir√° a Firebase cuando haya conexi√≥n.");
    let guardados = JSON.parse(localStorage.getItem("comentariosOffline") || "[]");
    guardados.push({ mensaje: texto, fecha: new Date().toISOString() });
    localStorage.setItem("comentariosOffline", JSON.stringify(guardados));
    return;
  }
  // Si hay internet, guarda en Firebase
  const nuevaRef = database.ref('comentarios').push();
  nuevaRef.set({ mensaje: texto, fecha: new Date().toISOString() });
}

// üìÑ Mostrar comentarios (solo si hay conexi√≥n)
function mostrarComentariosFirebase() {
  if (offlineMode) {
    typeMessage("‚ö†Ô∏è No se pueden cargar los comentarios porque est√°s sin conexi√≥n. Pero el resto del chat sigue activo. üòä");
    return;
  }

  database.ref('comentarios').orderByChild('fecha').limitToLast(50).once('value', snapshot => {
    const comentarios = snapshot.val();
    if (!comentarios) {
      typeMessage("üì≠ No hay comentarios guardados a√∫n.");
      return;
    }
    let texto = "üóÇÔ∏è <strong>Comentarios guardados:</strong><br><br>";
    Object.values(comentarios).forEach((c, i) => {
      texto += `${i + 1}. [${new Date(c.fecha).toLocaleString()}] ${c.mensaje}<br>`;
    });
    typeMessage(texto);
  });
}

// FAQ y preguntas 
const faqSections = [
 { title: "üîê Usuario y Contrase√±a", items: [
      ["¬øQu√© usuario y contrase√±a debo utilizar para inscribirme al curso?", "Su usuario es el RFC con homoclave (min√∫sculas). La contrase√±a inicial es <strong>Pac_2025</strong>; si ya la modific√≥ en un evento anterior, utilice la asignada."],
      ["¬øPor qu√© cuando pongo mi usuario y contrase√±a me dice datos err√≥neos?", "<br> A) Aseg√∫rese de escribir correctamente su RFC con homoclave en min√∫sculas. <br><br> B)Si no recuerda su contrase√±a puede llamar a las ext. 41805 y se la restableceremos para que coloque una nueva. "],
      ["¬øCu√°l es mi usuario y contrase√±a?", ""],
      ["Ya puse mi RFC y n√∫mero de empleado y no puedo entrar a la oficina virtual. ¬øUsted me puede dar mi contrase√±a?", ""],
      ["¬øPor qu√© cuando me quiero inscribir no veo el curso solo me aparece usuario y contrase√±a?", ""],
      ["¬øPor qu√© la p√°gina de capacitaci√≥n me aparece en ingl√©s?", ""]
    ]},

     { 
    title: "üßæ Inscripci√≥n y Acceso a Cursos",items: [
      ["¬øPor qu√© no encuentro en la plataforma el curso al que me invitaron?", ""],
      ["¬øC√≥mo me puedo inscribir a un curso?", "Sigue estos pasos para inscribirte a un curso:<br>1Ô∏è‚É£ Entra al sitio de la Direcci√≥n General de Personal: <a href='https://www.personal.unam.mx' target='_blank'>https://www.personal.unam.mx </a><br>2Ô∏è‚É£ Da clic en la opci√≥n <strong>OFICINA VIRTUAL</strong> y teclea tu <strong>R.F.C.</strong> con homoclave y <strong>N.I.P.</strong> (si el(la) trabajador(a) no recuerda su NIP, debe acudir al √Årea de Personal de su dependencia de adscripci√≥n).<br>3Ô∏è‚É£ En el apartado <strong>Inscripci√≥n y Registro</strong>, da clic en la opci√≥n <strong>Inscripci√≥n a Eventos de Capacitaci√≥n</strong>.<br>4Ô∏è‚É£ Verifica y/o actualiza tus <strong>DATOS PERSONALES</strong>.<br>5Ô∏è‚É£ Actualiza los datos del jefe que realiza la <strong>AUTORIZACI√ìN DE LA INSCRIPCI√ìN</strong>.<br>6Ô∏è‚É£ Da clic en el bot√≥n <strong>Guardar Datos Personales</strong>.<br>7Ô∏è‚É£ Para proceder a una inscripci√≥n, utiliza el bot√≥n <strong>Registrar Inscripci√≥n a Eventos</strong>.<br>8Ô∏è‚É£ En la lista desplegable <strong>Eventos</strong>, selecciona el nombre del curso al que deseas inscribirte (se encuentran en orden alfab√©tico).<br>9Ô∏è‚É£ En la opci√≥n <strong>Fechas y Horarios del Evento</strong> seleccionado, da clic en la clave del curso que tenga la fecha y hora del evento convocado (por ejemplo, <strong>PAC288</strong>).<br>üîü Presiona el bot√≥n <strong>Guardar Inscripci√≥n</strong>.<br>En la parte inferior de la ventana aparecer√°n todos los <strong>Registros de Inscripci√≥n</strong> del a√±o actual."],
      ["¬øPor qu√© me rechazaron del curso de c√≥mputo?", ""],
      ["Al formulario le di enviar respuestas, ¬øC√≥mo puedo saber si qued√© inscrita?", ""],
      ["El curso empez√≥ hoy, ¬øTodav√≠a me puedo inscribir?", "S√≠, comunic√°ndose v√≠a telef√≥nica o correo electr√≥nico. Se le dar√° atenci√≥n si es viable por cuestiones de cupo."],
      ["Me inscrib√≠ al curso‚Ä¶ ¬øPor qu√© no me ha llegado la confirmaci√≥n?", "Comun√≠quese por tel√©fono o por correo electr√≥nico para verificar la disponibilidad. La atenci√≥n est√° sujeta al cupo existente."],
      ["No encuentro el curso en el que estoy inscrita, ¬øC√≥mo entro?", "Para acceder al desarrollo de cualquier evento de capacitaci√≥n es necesario ingresar a nuestra plataforma Caplin desde la siguiente liga:<br><br>‚û°Ô∏è <a href='https://capacitacion.dgp.unam.mx/SCyE/' target='_blank'>https://capacitacion.dgp.unam.mx/SCyE/</a><br><br>üîπ Usuario: RFC con homoclave (en min√∫sculas)<br>üîπ Contrase√±a: <strong>Pac_2025</strong> o la propia si usted la personaliz√≥."],
      ["¬øPor qu√© no puedo inscribirme en la plataforma?", "La inscripci√≥n est√° limitada a un m√°ximo de 6 cursos por a√±o. Si necesitas tomar este curso de manera excepcional, puedes solicitarlo enviando un correo a <a href='mailto:maribel.perez@dgp.unam.mx'>maribel.perez@dgp.unam.mx</a>."]
    ]},


     { title: "üß† Contenido o Repetici√≥n de Cursos", items: [
      ["Ya tom√© el curso de Relaciones Laborales en el 2016, ¬øEs necesario volverlo a tomar?", ""],
      ["El curso tal..., ¬øTiene cambios sustanciales que valga la pena volverlo a tomar?", ""],
      ["¬øCu√°ntos cursos puedo tomar en el a√±o?", "Cada persona trabajadora puede participar en m√°ximo seis eventos de capacitaci√≥n al a√±o."],
      ["¬øCu√°ntos cursos puedo tomar al mismo tiempo?", "Para asegurar un mejor aprendizaje y dedicaci√≥n, sugerimos que los cursos de su inter√©s no se programen en las mismas fechas u horarios."],
      ["¬øCu√°ntas veces puedo tomar el mismo curso?", ""],
      ["No soy personal de la UNAM, ¬øPuedo tomar cursos de c√≥mputo?", ""],
      ["Soy hijo de una trabajadora, ¬øC√≥mo me puedo inscribir a sus cursos?", ""],
      ["¬øLos cursos de c√≥mputo tienen cost√≥?", ""],
      ["Si soy de nuevo ingreso, ¬øPuedo tomar el taller de Redacci√≥n B√°sica?", ""],
      ["üß† CURSOS DISPONIBLES", "üìã  Aqu√≠ tienes los <strong>subprogramas de capacitaci√≥n</strong> y algunos cursos destacados de la plataforma UNAM: <br><br><strong>1. Actualizaci√≥n T√©cnico Administrativa </strong>.<br><strong>2. Identidad Institucional </strong>.<br><strong>3. Cultura de Calidad </strong>.<br>4. <strong>Desarrollo humano y organizacional.</strong> <br><strong>5. Mandos Medios y Disponible. </strong><br><strong>6. Procesos Administrativos. </strong><br><strong>7. Cultura inform√°tica. </strong><br><strong> 8. Igualdad de G√©nero. </strong><br> <br> üîπDIRECCION: Extienda 1 de la UNAM, frente al estacionamiento 3 del Estadio Ol√≠mpico Universitario. <br><br>‚û°Ô∏è Accede directamente aqu√≠: <a href='https://www.personal.unam.mx/scye/' target='_blank'>https://www.personal.unam.mx/scye/</a>"]
    ]},

    { title: "üïì Fechas, Programaci√≥n y Modalidad", items: [
      ["¬øTodav√≠a est√° programado para la misma fecha el curso tal?", ""],
      ["¬øPor qu√© en la circular DGPe/035/2023 dice una fecha y en la plataforma otra?", ""],
      ["¬øQu√© instructor va a impartir el curso?", ""],
      ["¬øTodav√≠a no hay cursos presenciales?", "S√≠, la modalidad presencial ya se est√° llevando a cabo. Nuestras instalaciones se encuentran en‚Ä¶  <br><br> üîπDIRECCION: Extienda 1 de la UNAM, frente al estacionamiento 3 del Estadio Ol√≠mpico Universitario."],
      ["¬øPuedo hacer la evaluaci√≥n de c√≥mputo ahorita?", ""],
      ["¬øCu√°ndo es la evaluaci√≥n de ingl√©s y c√≥mputo?", ""],
      ["Hoy no pude hacer el curso Bienvenida a la UNAM, ¬øLo puedo hacer ma√±ana?", ""]
    ]},

   { title: "üí¨ Zoom y Asistencia", items: [
      ["¬øPor qu√© no he recibido la liga para entrar a la reuni√≥n de Zoom?", "La liga de acceso a las sesiones de zoom se encuentran dentro del desarrollo del curso, por lo cual es necesario ingresar a la Plataforma Caplin <br>‚û°Ô∏è Accede directamente aqu√≠: <a href='https://capacitacion.dgp.unam.mx/SCyE/' target='_blank'>https://capacitacion.dgp.unam.mx/SCyE/</a>"],
      ["¬øS√≠ va a haber reuni√≥n Zoom?", ""],
      ["¬øEn qu√© parte del curso est√° el link para entrar al Zoom?", "En el desarrollo del curso ubique el siguiente √≠cono:<br><img src='img/zoom_icono.png' alt='√çcono de reuni√≥n Zoom en el curso' style='max-width:100%; border-radius:10px; margin:8px 0;'><br> De clic y posteriormente en <strong>‚ÄúUnirse a la reuni√≥n‚Äù</strong>:<br> <img src='img/zoom_unirse.png' alt='Bot√≥n Unirse a la reuni√≥n en el curso' style='max-width:100%; border-radius:10px; margin-top:8px;'>"],
      ["¬øC√≥mo le hago para registrar mi asistencia del curso por Zoom?", "El registro de asistencia es autom√°tico <strong>√∫nicamente</strong> cuando se accede a la sesi√≥n de Zoom desde la Plataforma Caplin. Por favor, evite el uso directo de la liga o el ID de la sesi√≥n, ya que esto impedir√° el registro de su participaci√≥n."]
    ]},

    { title: "üìú Constancias y Evaluaciones", items: [
      ["¬øCu√°nto saqu√© en el curso, no puedo ver la calificaci√≥n?.", "La calificaci√≥n y constancia est√° disponible en la oficina virtual despu√©s de transcurrir 10 d√≠as h√°biles al t√©rmino del evento."],
      ["¬øC√≥mo puedo saber si aprob√© el curso?", ""],
      ["Tom√© el curso, ¬øCu√°nto tardan en darme la constancia?", "Si aprob√≥ el curso con una calificaci√≥n m√≠nima de 8, la constancia estar√° disponible en la oficina virtual despu√©s de transcurrir 10 d√≠as h√°biles al t√©rmino del evento."],
      ["¬øEn d√≥nde encuentro mi constancia?", "La constancia puede ser descargada en formato electr√≥nico diez d√≠as h√°biles posteriores al t√©rmino del evento, desde la Oficina Virtual que se encuentra en el sitio web de la Direcci√≥n General de Personal: <a href='https://www.personal.unam.mx' target='_blank'>https://www.personal.unam.mx</a>. <br>Para obtener su constancia, realice lo siguiente:<br>I. Ingresar a la <strong>Oficina Virtual</strong> con su usuario y contrase√±a (si desconoce estos datos, acuda al Departamento de Personal de la Secretar√≠a o Unidad Administrativa de su dependencia).<br>II. Localizar la secci√≥n de <strong>Informaci√≥n Personal</strong> y hacer clic en la opci√≥n <strong>Expediente</strong>.<br>III. Seleccionar la opci√≥n <strong>Capacitaci√≥n > Cursos Confianza</strong>.<br>IV. Identificar el nombre de este evento.<br>V. Hacer clic en el bot√≥n <strong>Descargar</strong>."],
      ["¬øPor qu√© no puedo descargar mis constancias?", ""],
      ["üìú OBTENER MI CONSTANCIA", "üîπ Pasos para obtener tu constancia:<br>1Ô∏è‚É£ Ingresa al portal oficial de capacitaci√≥n.<br>2Ô∏è‚É£ Inicia sesi√≥n con tu usuario y contrase√±a institucional.<br>3Ô∏è‚É£ Dir√≠gete al men√∫ 'Historial de cursos'.<br>4Ô∏è‚É£ Localiza el curso que completaste.<br>5Ô∏è‚É£ Haz clic en 'Descargar constancia'.<br><br>‚û°Ô∏è Accede directamente aqu√≠: <a href='https://www.personal.unam.mx/dgpe/' target='_blank'>https://www.personal.unam.mx/dgpe/</a>"],
    ]},

    { title: "üè¢ Oficina Virtual y DGPE", items: [
      ["¬øC√≥mo entro a la oficina virtual?", "Es necesario ingresar a <a href='https://www.personal.unam.mx' target='_blank'>www.personal.unam.mx</a>.<br><br> üîπ Da clic en la opci√≥n <strong>Oficina Virtual</strong>:<br> <img src='img/oficina_virtual.png' alt='Ubicaci√≥n del bot√≥n Oficina Virtual' style='max-width:100%; border-radius:10px; margin-top:5px;'><br><br> üîπ Posteriormente, ingresa tu <strong>RFC</strong> y <strong>NIP</strong> en el Sistema de Autenticaci√≥n:<br> <img src='img/login_unam.png' alt='Pantalla de acceso RFC y NIP' style='max-width:100%; border-radius:10px; margin-top:5px;'>"],
      ["¬øEn qu√© parte de la oficina virtual est√°n las constancias?", "<br> 1. Localizar la secci√≥n de ‚ÄúInformaci√≥n Personal‚Äù, y hacer clic en la opci√≥n ‚ÄúExpediente‚Äù, <br> 2. Seleccionar la opci√≥n <strong> Capacitaci√≥n > Cursos Confianza </strong> <br> 3. Identificar el nombre del evento, <br> 4.Hacer clic en el bot√≥n ‚ÄúDescargar‚Äù."],
      ["Estoy en la p√°gina de la DGPE, ¬øEn qu√© parte puedo ver el programa de capacitaci√≥n?", ""]
    ]},

    { 
    title: "üì® Tr√°mites Administrativos", items: [
      ["¬øEn d√≥nde est√°n ubicados?, para enviar correspondencia.", ""],
      ["¬øCu√°l es la extensi√≥n de tal..?", ""],
      ["¬øEs necesario enviar en f√≠sico el oficio de autorizaci√≥n de mi jefe para tomar mi curso?", "No, puede enviarlo por correo electr√≥nico a <a href='mailto:scye_capacitacion@dgp.unam.mx'>scye_capacitacion@dgp.unam.mx</a>."],
      ["¬øMi jefe debe mandar un oficio autorizando mi participaci√≥n en el curso?", "S√≠, esta acci√≥n es necesaria √∫nicamente cuando ya se ha alcanzado el l√≠mite de seis cursos registrados en el a√±o. Favor de enviarlo al correo <a href='mailto:scye_capacitacion@dgp.unam.mx'>scye_capacitacion@dgp.unam.mx</a>."],
      ["¬øSi entro a la plataforma, yo puedo inscribir a mi jefe?", ""]
    ]
  },
];
function showFAQ(){
  chatContent.innerHTML="";
  faqSections.forEach((sec,index)=>{
    const det=document.createElement('details');
    const sum=document.createElement('summary');
    sum.textContent=sec.title;
    det.appendChild(sum);

    sum.onclick=()=>{faqSections.forEach((_,i)=>{if(i!==index) document.querySelectorAll('details')[i].style.display='none';});}

    sec.items.forEach(([q,a])=>{
      const b=document.createElement('button');
      b.classList.add('faq-btn');
      b.textContent=q;
      b.onclick=()=>{
        appendMessage("T√∫",q,"user"); 
        typeMessage(a);
        // Despu√©s de responder FAQ, preguntar si necesitan m√°s ayuda
        setTimeout(() => {
          typeMessage("üòä ¬øNecesitas algo m√°s? Escribe 'S√≠' para volver al men√∫ principal o 'No' para finalizar.");
          waitingMoreHelp = true;
        }, 60 * 18000); // ‚è∞ 1 minutos (60,000 milisegundos)

      };
      det.appendChild(b);
    });

    const customBtn=document.createElement('button');
    customBtn.classList.add('faq-btn');
    customBtn.textContent="üìå ESCRIBA SU DUDA ";
    customBtn.onclick=()=>{appendMessage("T√∫","[Duda personalizada]","user"); typeMessage("Escribe tu duda en el cuadro de texto y te responder√©.");};
    det.appendChild(customBtn);

    const backBtn=document.createElement('button');
    backBtn.classList.add('back-btn');
    backBtn.textContent="üîô VOLVER AL MEN√ö PRINCIPAL";
    backBtn.onclick=()=>{showFAQ();}
    det.appendChild(backBtn);

    chatContent.appendChild(det);
  });
  chatContent.scrollTop=chatContent.scrollHeight;
}

// Escuchar cambios en la conexi√≥n a internet
// üîπ Detectar conexi√≥n al cargar la p√°gina (por si el lugar no tiene internet)
window.addEventListener('load', () => {
  if (!navigator.onLine) {
    // Si el chat ya est√° abierto
    if (chatBoxContainer.style.display === 'flex') {
      typeMessage("‚ö†Ô∏è Este dispositivo no tiene conexi√≥n a internet. El chatbot no funcionar√° hasta que se restablezca la conexi√≥n.");
    } else {
      // Si el chat a√∫n no se ha abierto, mostrar alerta general
      alert("‚ö†Ô∏è Este dispositivo no tiene conexi√≥n a internet. El chatbot no funcionar√° hasta que se restablezca la conexi√≥n.");
    }
  }
});

// üîπ Avisar pero permitir seguir usando el chatbot sin internet
window.addEventListener('offline', () => {
  offlineMode = true;
  if (chatBoxContainer.style.display === 'flex') {
    typeMessage("‚ö†Ô∏è Se ha perdido la conexi√≥n a internet, pero puedes seguir usando PumAI normalmente. üíõ Tus comentarios se guardar√°n localmente y se subir√°n cuando vuelva la conexi√≥n.");
  } else {
    alert("‚ö†Ô∏è Sin conexi√≥n. El chatbot funcionar√° en modo local hasta que regrese el internet.");
  }
});

// üîÑ Sincronizar comentarios locales cuando vuelve la conexi√≥n
window.addEventListener("online", () => {
  offlineMode = false;
  if (localStorage.getItem("comentariosOffline")) {
    const pendientes = JSON.parse(localStorage.getItem("comentariosOffline"));
    pendientes.forEach(c => {
      const nuevaRef = database.ref('comentarios').push();
      nuevaRef.set(c);
    });
    localStorage.removeItem("comentariosOffline");
    alert("‚úÖ Comentarios locales sincronizados con Firebase.");
  }
  typeMessage("‚úÖ ¬°Conexi√≥n restaurada! Puedes seguir usando el chatbot con normalidad.");
});


</script>
</body>
</html>